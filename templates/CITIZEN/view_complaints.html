{% extends 'CITIZEN/commen.html' %}
{% block content %}

<h3>My Complaints</h3>

<a href="/citizen_add_complaint/" class="btn btn-success mb-3">+ Add Complaint</a>

{% if complaints %}
<table class="table table-bordered">
    <tr>
        <th>Title</th>
        <th>Department</th>
        <th>Location</th>
        <th>Image</th>
        <th>Status</th>
        <th>Latest Action</th>
        <th>Feedback</th>
        <th>Report</th>
        <th>Details</th>
    </tr>

    {% for c in complaints %}
    <tr>
        <td>{{ c.title }}</td>
        <td>{% if c.department %}{{ c.department.name }}{% else %}-{% endif %}</td>
        <td>{{ c.location }}</td>
        <td>
            {% if c.damaged_image %}
            <a href="{{ c.damaged_image.url }}" target="_blank">
                <img src="{{ c.damaged_image.url }}" alt="Complaint Image"
                    style="max-width: 80px; max-height: 80px; cursor: pointer;" class="img-thumbnail">
            </a>
            {% else %}
            <span class="text-muted">No image</span>
            {% endif %}
        </td>
        <td>{{ c.status }}</td>
        <td>
            {% with action=c.complaintaction_set.last %}
            {% if action %}
            {{ action.action_note }} <br>
            <small>Status: {{ action.status_updated_to }} By: {{ action.staff.name }}</small>
            {% else %}
            <span class="text-muted">No action yet</span>
            {% endif %}
            {% endwith %}
        </td>
        <td>
            {% if c.status == "Completed" or c.status == "Finished" %}
            <form method="POST" action="/add_feedback/">
                {% csrf_token %}
                <input type="hidden" name="complaint_id" value="{{ c.id }}">
                <div class="input-group">
                    <input type="text" name="message" class="form-control" placeholder="Feedback" required>
                    <input type="number" name="rating" min="1" max="5" class="form-control" placeholder="Rating"
                        required>
                    <button type="submit" class="btn btn-success btn-sm">Submit</button>
                </div>
            </form>
            {% else %}
            <span class="text-muted">Cannot add</span>
            {% endif %}
        </td>
        <td>
            {% if c.status == "Completed" or c.status == "Finished" %}
            <a href="/add_report/?id={{ c.id }}" class="btn btn-danger btn-sm">Add Report</a>
            {% else %}
            <span class="text-muted">Cannot add</span>
            {% endif %}
        </td>
        <td>
            <a href="/citizen_complaint_detail/?id={{ c.id }}" class="btn btn-info btn-sm">üëÅ View</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No complaints submitted yet.</p>
{% endif %}

{% endblock %}